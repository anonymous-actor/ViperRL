<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Video Prediction Rewards</title> <meta name="author" content=" "/> <meta name="description" content="Using advances in generative modeling to learn reward functions from unlabeled videos."/> <meta name="keywords" content="AI, robotics, ML, artificial, intelligence, reinforcement, learning"/> <meta property="og:site_name" content="Video Prediction Rewards"/> <meta property="og:type" content="website"/> <meta property="og:title" content="Video Prediction Rewards | Video Prediction Models as Rewards for Reinforcement Learning"/> <meta property="og:url" content="https://anonymous-actor.github.io/ViperRL//"/> <meta property="og:description" content="Using advances in generative modeling to learn reward functions from unlabeled videos."/> <meta property="og:locale" content="en"/> <meta name="twitter:card" content="summary"/> <meta name="twitter:title" content="Video Prediction Models as Rewards for Reinforcement Learning"/> <meta name="twitter:description" content="Using advances in generative modeling to learn reward functions from unlabeled videos."/> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"/> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="none" id="highlight_theme_light"/> <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üêçÔ∏è</text></svg>"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://anonymous-actor.github.io/ViperRL//"> </head> <body class=" sticky-bottom-footer"> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Video Prediction Models as Rewards for Reinforcement Learning</h1> <p class="post-description">Using advances in generative modeling to learn reward functions from unlabeled videos.</p> </header> <article> <h2 id="overview">Overview</h2> <hr> <p>In this work, we propose using Video Prediction Rewards (VIPER) for reinforcement learning. VIPER first learns a video prediction model from expert videos. We then train an agent using reinforcement learning to maximize the log-likelihood of agent trajectories estimated by the video prediction model. Directly leveraging the video model‚Äôs likelihoods as a reward signal encourages the agent to match the video model‚Äôs trajectory distribution. Additionally, rewards specified by video models inherently measure the temporal consistency of behavior, unlike observation-level rewards. Further, evaluating likelihoods is significantly faster than performing video model rollouts, enabling faster training times and more interactions with the environment.</p> <div class="embed-responsive embed-responsive-4by3"> <video controls="" autoplay="" muted="" loop=""> <source src="/assets/vid/viper_method.mp4" type="video/mp4"></source> </video> </div> <p>We summarize the three key contributions of this paper as follows:</p> <ul> <li>We present VIPER: a novel, scalable reward specification algorithm which leverages rapid improvements in generative modeling to provide RL agents with rewards from unlabeled videos.</li> <li>We perform an extensive evaluation, and show that VIPER can achieve expert-level control without task rewards on 15 DMC tasks, 6 RLBench tasks, and 7 Atari tasks.</li> <li>We demonstrate that VIPER generalizes to different environments for which no training data was provided, enabling cross-embodiment generalization for tabletop manipulation.</li> </ul> <p>Along the way, we discuss important implementation details that improve the robustness of VIPER.</p> <p><br></p> <h2 id="leveraging-video-prediction-rewards-for-reinforcement-learning">Leveraging Video Prediction Rewards for Reinforcement Learning</h2> <hr> <p><br></p> <h3 id="video-modeling">Video Modeling</h3> <p>Our method can integrate any video model that supports computing likelihoods over the joint distribution factorized in the following form:</p> \[\log p(x_{1:T}) = \sum_{t=1}^T \log p(x_t\mid x_{1:t-1}),\] <p>where \(x_{1:T}\) is the full video consisting of \(T\) frames, \(x_1,\dots,x_T\).</p> <p>In this paper, we use an autoregressive transformer model based on VideoGPT as our video generation model. We first train a VQ-GAN to encode individual frames \(x_t\) into discrete codes \(z_t\). Next, we learn an autoregressive transformer to model the distribution of codes \(z\) through the following maximum likelihood objective:</p> \[\max_{\theta} \sum_{t=1}^T \sum_{i=1}^Z \log p_\theta(z^i_t \mid z^{1:i-1}_t, z_{1:t-1}),\] <p>The resulting video model is able to produce videos that capture the complex dynamics and behaviors in each environment. For example, a single task-conditond video model trained on 45 RLBench tasks across two arms produces rollouts which accurately model each task:</p> <p><img class="mx-auto d-block img-fluid rounded" style="width: 100%;" src="/assets/gif/rlbench_samples_final.gif"></p> <p><br></p> <h3 id="reward-formulation">Reward Formulation</h3> <p>Given a pretrained video model, VIPER proposes an intuitive reward that maximizes the conditional log-likelihoods for each transition \((x_t, a_t, x_{t+1})\) observed by the agent:</p> \[r^{\mathrm{VIPER}}_t \doteq \ln p_\theta(x_{t+1}|x_{1:t}).\] <p>This reward incentivizes the agent to find the most likely trajectory under the expert video distribution as modeled by the video model. However, the most probable sequence does not necessarily capture the distribution of behaviors we want the agent to learn.</p> <p>For example, when flipping a weighted coin with \(p(\text{heads} = 0.6)\) 1000 times, typical sequences will count roughly 600 heads and 400 tails, in contrast to the most probable sequence of 1000 heads that will basically never be seen in practice. Similarly, the most likely image under a density model trained on MNIST images is often the image of only background without a digit, despite this never occurring in the dataset. In the reinforcement learning setting, an additional issue is that solely optimizing a dense reward such as \(r^{\mathrm{VIPER}}_t\) can lead to early convergence to local optima.</p> <p>To overcome these challenges, we take the more principled approach of matching the agent‚Äôs trajectory distribution \(q(x_{1:T} )\) to the sequence distribution \(p_\theta(x_{1:T} )\) of the video model by minimizing the KL-divergence between the two distributions. We refer the reader to the main text for all derivations. The resulting reward is given by:</p> \[r^{\mathrm{KL}}_t \doteq r^{\mathrm{VIPER}}_t+\beta r^\mathrm{expl}_t,\] <p>Where \(\beta\) balances the relative importance of the VIPER and exploration rewards. We summarize VIPER in the figure below:</p> <div class="row"> <div class="text-center col-12 col-sm-12 col-md-12 mt-4 mt-md-0"> <figure class="figure mx-auto d-block rounded"> <img class="mx-auto d-block img-fluid rounded" src="/assets/img/viper/viper_method_figure.png"> <figcaption class="figure-caption text-center">Full outline of the VIPER algorithm.</figcaption> </figure> </div> </div> <p><br></p> <h2 id="benchmarks">Benchmarks</h2> <hr> <p>We evaluate using VIPER rewards for policy learning on 15 tasks from the DeepMind Control Suite, 7 tasks from Atari Gym, and 6 tasks from the Robot Learning Benchmark. Aggregate plots of the results are shown below. We compare VIPER to Adversarial Motion Priors, and to a Task Oracle with access to full state information and task reward.</p> <div class="row"> <div class="text-center col-12 col-sm-12 col-md-12 mt-4 mt-md-0"> <figure class="figure mx-auto d-block rounded"> <img class="mx-auto d-block img-fluid rounded" src="/assets/img/viper/results_agg.png"> <figcaption class="figure-caption text-center">Aggregate results across 15 DMC tasks, 7 Atari games, and 6 RLBench tasks. DMC results are provided for DrQ and DreamerV3 (Dv3) RL agents. Atari and RLBench results are reported for DreamerV3. Atari scores are computed using Human-Normalized Mean.</figcaption> </figure> </div> </div> <div class="row"> <div class="text-center col-12 col-sm-12 col-md-5 mt-4 mt-md-0"> <figure class="figure mx-auto d-block"> <img class="mx-auto d-block img-fluid rounded" style="width: 100%;" src="/assets/gif/VIPER/DMC_GIFS_final.gif"> <figcaption class="figure-caption text-center">Sample policies learned for the DeepMind Control Suite set of tasks.</figcaption> </figure> </div> <div class="text col-12 col-sm-12 col-md-7 mt-4 mt-md-0"> <p>In DMC, VIPER achieves near expert-level performance from pixels with our video prediction rewards alone. Although VIPER slightly underperforms Task Oracle, this is surprising as the Task Oracle uses full state information along with dense task rewards. VIPER outperforms both variants of AMP. Worth noting is the drastic performance difference between the single-task and multi-task AMP algorithms. This performance gap can possibly be attributed to mode collapse, whereby the discriminator classifies all frames for the current task as fake samples, leading to an uninformative reward signal for the agent. Likelihood-based video models, such as VIPER, are less susceptible to mode collapse than adversarial methods.</p> </div> </div> <div class="row"> <div class="text col-12 col-sm-12 col-md-12 mt-4 mt-md-0"> <p>In Atari, VIPER approaches the performance of the Task Oracle trained with the original sparse task reward, and outperforms the AMP baseline. We found that masking the scoreboard in each Atari environment when training the video model improved downstream RL performance. </p> </div> </div> <div class="row"> <div class="text-center col-12 col-sm-12 col-md-12 mt-4 mt-md-0"> <figure class="figure mx-auto d-block"> <img class="mx-auto d-block img-fluid rounded" style="width: 100%" src="/assets/gif/VIPER/ATARI_GIFS_final.gif"> <figcaption class="figure-caption text-center">Sample policies learned for Atari games.</figcaption> </figure> </div> </div> <div class="row"> <div class="text col-12 col-sm-12 col-md-12 mt-4 mt-md-0"> <p>For RLBench, VIPER outperforms the Task Oracle because RLBench tasks provide very sparse rewards after long sequences of actions, which pose a challenging objective for RL agents. VIPER instead provides a dense reward extracted from the expert videos, which helps learn these challenging tasks. When training the video model, we found it beneficial to train at a reduced frame rate, accomplished by subsampling video sequences by a factor of 4. Otherwise, we observed the video model would assign high likelihoods to stationary trajectories, resulting in learned policies rarely moving and interacting with the scene. We hypothesize that this may be partially due to the high control frequency of the environment, along with the initial slow acceleration of the robot arm in demonstrations, resulting in very little movement between adjacent frames.</p> </div> </div> <div class="row"> <div class="text-center col-12 col-sm-12 col-md-12 mt-4 mt-md-0"> <figure class="figure mx-auto d-block"> <img class="mx-auto d-block img-fluid rounded" style="width: 100%;" src="/assets/gif/VIPER/RLBench_final.gif"> <figcaption class="figure-caption text-center">Sample policies learned for RLBench manipulation tasks.</figcaption> </figure> </div> </div> <p><br></p> <h2 id="cross-embodiment-generalization">Cross-Embodiment Generalization</h2> <hr> <p>We seek to understand how this generalization can be used to learn more general reward functions. We train a model on two datasets of different robot arms, and evaluate the cross-embodiment generalization capabilities of the model. Specifically, we gather demonstrations for 23 tasks on the Rethink Robotics Sawyer Arm, and demonstrations for 30 tasks on the Franka Panda robotic arm, where only 20 tasks are overlapping between arms. We then train a task-conditioned autoregressive video model on these demonstration videos and evaluate the video model by querying unseen arm/task combinations, where a single initial frame is used for open loop predictions.</p> <p>Sample video model rollouts for in distribution training tasks and an OOD arm/task combination are shown below:</p> <figure class="figure mx-auto d-block"> <div class="row"> <div class="text-center col-4 col-sm-4 col-md-4 mt-4 mt-md-0"> <img class="mx-auto d-block w-100 rounded border border-warning" style="border-width: 5px !important;" src="/assets/gif/VIPER/generalization_saucepan_sawyer.gif"> </div> <div class="text-center col-4 col-sm-4 col-md-4 mt-4 mt-md-0"> <img class="mx-auto d-block w-100 rounded border border-warning" style="border-width: 5px !important;" src="/assets/gif/VIPER/generalization_umbrella_panda.gif"> </div> <div class="text-center col-4 col-sm-4 col-md-4 mt-4 mt-md-0"> <img class="mx-auto d-block w-100 rounded border border-success" style="border-width: 5px !important;" src="/assets/gif/VIPER/generalization_saucepan_panda.gif"> </div> </div> <figcaption class="figure-caption text-center">Sampled video predictions for in distribution reference videos (Left and Middle) and an OOD arm/task combination (Right). The video model displays cross-embodiment generalization to arm/task combination not observed in the training data. Video model generalization can enable specifying new tasks where no reference data is available.</figcaption> </figure> <p>Even though the video model was not directly trained on demon- strations of the Franka Panda arm to solve the saucepan task in RLBench, it is able to generate reasonable trajectories for the arm and task combination</p> <p>We observe that these generalization capabilities also extend to downstream RL, where we use our trained video model with VIPER to learn a policy for the Franka Robot arm to solve an OOD task without requiring demos for that specific task and arm combination. These results demonstrate a promising direction for future work in applying VIPER to larger scale video models that will be able to better generalize and learn desired behaviors only through a few demonstrations.</p> <div class="row form-group"> <div class="text-center col-12 col-sm-12 col-md-12 mt-4 mt-md-0"> <figure class="figure mx-auto d-block rounded"> <img class="mx-auto d-block img-fluid rounded" style="width: 80%;" src="/assets/img/viper/cross_embodiment_generalization.png"> <figcaption class="figure-caption text-center">(Left) Training curve for RL agent trained with VIPER on OOD task. (Right) Task-conditional likelihood for reference and random trajectory for an OOD task.</figcaption> </figure> </div> </div> <p><br></p> <h2 id="visualizing-video-model-uncertainty">Visualizing Video Model Uncertainty</h2> <hr> <p>We can visualize the the uncertainty of the video model by upsampling per-frame log-probabilities for each VQCode. We find that the video model correctly assigns low log probs to trajectories that are not consistent with the reference videos, and high log probs to trajectories that are consistent with the reference videos. We show this for low return trajectories and expert trajectories in the figure below:</p> <figure class="figure mx-auto d-block"> <div class="row form-group"> <div class="text-center col-6 col-sm-6 col-md-6 mt-4 mt-md-0"> <img class="mx-auto d-block w-100 rounded border border-danger" style="border-width: 10px !important; width: 100%;" src="/assets/gif/VIPER/uncertainty_atari_bad.gif"> </div> <div class="text-center col-6 col-sm-6 col-md-6 mt-4 mt-md-0"> <img class="mx-auto d-block w-100 rounded border border-success" style="border-width: 3px !important; width: 100%;" src="/assets/gif/VIPER/uncertainty_atari_good.gif"> </div> </div> <div class="row form-group"> <div class="text-center col-6 col-sm-6 col-md-6 mt-4 mt-md-0"> <img class="mx-auto d-block w-100 rounded border border-danger" style="border-width: 3px !important; width: 100%;" src="/assets/gif/VIPER/uncertainty_rlbench_bad.gif"> </div> <div class="text-center col-6 col-sm-6 col-md-6 mt-4 mt-md-0"> <img class="mx-auto d-block w-100 rounded border border-success" style="border-width: 3px !important; width: 100%;" src="/assets/gif/VIPER/uncertainty_rlbench_good.gif"> </div> </div> <div class="row form-group"> <div class="text-center col-6 col-sm-6 col-md-6 mt-4 mt-md-0"> <img class="mx-auto d-block w-100 rounded border border-danger" style="border-width: 3px !important; width: 100%;" src="/assets/gif/VIPER/uncertainty_dmc_bad.gif"> </div> <div class="text-center col-6 col-sm-6 col-md-6 mt-4 mt-md-0"> <img class="mx-auto d-block w-100 rounded border border-success" style="border-width: 3px !important; width: 100%;" src="/assets/gif/VIPER/uncertainty_dmc_good.gif"> </div> </div> <figcaption class="figure-caption text-center">Upsampled VQCode conditional log probabilities for low return trajectories (left) and expert trajectories (right). Visualizations correspond to Atari (top), RLBench (middle), and DeepMind Control (bottom). RLBench uses 16X16 VQCodes while DMC uses 8X8. Brighther colors correspond to higher log probabilities.</figcaption> </figure> <p><br></p> </article> </div> </div> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script async src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.2/dist/umd/popper.min.js" integrity="sha256-l/1pMF/+J4TThfgARS6KwWrk/egwuVvhRzfLAMQ6Ds4=" crossorigin="anonymous"></script> <script async src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js" integrity="sha256-SyTu6CwrfOhaznYZPoolVw2rxoY7lKYKQvqbtqN93HI=" crossorigin="anonymous"></script> <script async src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script defer src="/assets/js/copy_bib.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> </body> </html>